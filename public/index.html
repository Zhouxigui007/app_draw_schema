<!DOCTYPE html>
<html lang="uk"> 
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>App_draw_schemas</title>
</head>
<body>
  <script src="node_modules/drawflow/dist/drawflow.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js" integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs=" crossorigin="anonymous"></script>
  <link rel="stylesheet" type="text/css" href="drawflow.css" />
  <link rel="stylesheet" type="text/css" href="styles.css" />
  <link rel="stylesheet" type="text/css" href="buttons-styles.css" />
  <link rel="stylesheet" type="text/css" href="df-edit.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
  <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>

  <header>
    <h2>Diagrams of the relationships between disciplines</h2>
  </header>
  
  <div class="wrapper">
    <div class="col">
      <div class="sidebar-info">
        <div class="sidebar-header" id="infoHeader" onclick="toggleSidebarInfo()">
          <span>‚ÑπÔ∏è Information (click to expand/collapse)</span>
        </div>
        <div id="sidebarContent" class="sidebar-content collapsed">
          <h2 style="text-align: center;">Welcome!!!</h2>
          <p>This project is made using the <b>Drawflow</b> library.</p>
          <p><h3 style="text-align: center; text-decoration: underline;">Shortkeys:</h3></p>
          <p><b>Delete</b> ‚Äî to delete</p>
          <p><b>Left Mouse Button</b> ‚Äî to move</p>
          <p><b>Right Mouse Button</b> ‚Äî to delete</p>
          <p><b>Ctrl + Mouse Wheel</b> ‚Äî to zoom in</p>
          <p><h3 style="text-align: center; text-decoration: underline;">Button Functions:</h3></p>
          <p><b>Button with üîí</b> ‚Äî to lock elements</p>
          <p><b>Clear Editor</b> ‚Äî clears the editor for a new diagram. The current diagram is automatically saved</p>
          <p><b>Add Diagram</b> ‚Äî saves the current diagram on the server</p>
          <p><b>Export</b> ‚Äî exports the diagram in JSON format</p>
          <p><b>Import</b> ‚Äî imports the diagram in JSON format</p>
          <p><b>Delete</b> ‚Äî to delete the diagram from the server</p>
          <p><b>Buttons with Course Number</b> ‚Äî highlight subjects of the corresponding course</p>
        </div>
      </div>
      <div class="sidebar-subjects">
        <div class="sidebar-header" id="subjectsHeader" onclick="toggleSubjectsList()">
          <span>üìö Subject List (click to expand/collapse)</span>
        </div>
        <div id="subjectsList" class="sidebar-content collapsed">
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="blank">
            <i class="blank"></i><span>Blank Block</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="programming">
            <i class="programming"></i><span>Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="operation_sys">
            <i class="operation_sys"></i><span>Operating Systems</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="math_analysis">
            <i class="math_analysis"></i><span>Mathematical Analysis</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="algebra_geo">
            <i class="algebra_geo"></i><span>Algebra and Geometry</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="praktika">
            <i class="praktika"></i><span>Software Engineering Practicum</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ukr_lang">
            <i class="ukr_lang"></i><span>Ukrainian Language (for Professional Purposes)</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ukr_history">
            <i class="ukr_history"></i><span>Ukrainian Statehood and Culture</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="foreign_lang">
            <i class="foreign_lang"></i><span>Foreign Language</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="pidpriem">
            <i class="pidpriem"></i><span>Entrepreneurship</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="ekologiya">
            <i class="ekologiya"></i><span>Ecology</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="diferential_eq">
            <i class="diferential_eq"></i><span>Differential Equations</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="theory_of_probability">
            <i class="theory_of_probability"></i><span>Theory of Probability and Mathematical Statistics</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="diskret_math">
            <i class="diskret_math"></i><span>Computer Discrete Mathematics</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="physics">
            <i class="physics"></i><span>Physics</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="math_logic">
            <i class="math_logic"></i><span>Mathematical Logic, Theory of Algorithms and Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="object_oriented_programming">
            <i class="object_oriented_programming"></i><span>Object-Oriented Programming and Design Patterns</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="database">
            <i class="database"></i><span>Databases</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="web_programming">
            <i class="web_programming"></i><span>Web Programming and Cloud Technologies</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="mikrocontrollers">
            <i class="mikrocontrollers"></i><span>Microcontrollers and Systems Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="electronics">
            <i class="electronics"></i><span>Electrical Engineering and Computer Electronics</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="course_work_sys_prog">
            <i class="course_work_sys_prog"></i><span>Course Work on System Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="sensors_and_actuators">
            <i class="sensors_and_actuators"></i><span>Sensors and Actuators</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="computer_networks">
            <i class="computer_networks"></i><span>Computer Networks, Interfaces, and Data Transmission Protocols</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="information_security">
            <i class="information_security"></i><span>Information Security and Data Protection</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="course_work_prog">
            <i class="course_work_prog"></i><span>Course Work on Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="math_physics">
            <i class="math_physics"></i><span>Algorithms and Computational Methods of Mathematical Physics</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="machine_learning">
            <i class="machine_learning"></i><span>Machine Learning and Computational Intelligence</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="arduino_dev">
            <i class="arduino_dev"></i><span>Arduino Device Development</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="internet_of_things">
            <i class="internet_of_things"></i><span>Internet of Things Design, Construction, and Reliability</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="course_work_internet_of_things">
            <i class="course_work_internet_of_things"></i><span>Course Work on Internet of Things Programming</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="people_machine_interaction">
            <i class="people_machine_interaction"></i><span>Human-Machine Interaction and Basics of Computer Design</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="construction_of_software">
            <i class="construction_of_software"></i><span>Software Construction</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="management_quality_of_software">
            <i class="management_quality_of_software"></i><span>Software Quality Management</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="business_analytics">
            <i class="business_analytics"></i><span>Business Analytics and Teamwork in IT</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="bachelor_work">
            <i class="bachelor_work"></i><span>Bachelor's Qualification Work</span>
          </div>
          <div class="drag-drawflow" draggable="true" ondragstart="drag(event)" data-node="prod_pract">
            <i class="prod_pract"></i><span>Production Practice</span>
          </div>
        </div>
      </div>      
      <div class="wrapper-buttons">
      <button onclick="saveSchema()" class="btn-save-schema">Add Schema</button>
      <button onclick="startNewSchema()" class="btn-new-schema">Clear Editor</button>
      <button onclick="highlightCourse('1')" class="btn-course">1st Year</button>
      <button onclick="highlightCourse('2')" class="btn-course">2nd Year</button>
      <button onclick="highlightCourse('3')" class="btn-course">3rd Year</button>
      <button onclick="highlightCourse('4')" class="btn-course">4th Year</button>
      </div>
      <h3 class="schema-list-text">List of Saved Schemas:</h3>
      <div id="schema-buttons"></div>
    </div>
    
    <div class="col-right">
      <div class="menu">
        <input type="text" class="title-input" placeholder="Enter the scheme name">
      </div>
      <div id="drawflow" ondrop="drop(event)" ondragover="allowDrop(event)">
       <button class="btn-export" id="btnExport" onclick="exportJSONFromDatabase(currentSchemaId)">Export</button>
       <input type="file" id="importFile" style="display: none" onchange="importJSONFromFile(event)">
       <button class="btn-import" id="btnImport" onclick="document.getElementById('importFile').click()">Import</button>
        <button class="btn-clear" disabled>Delete</button>
        <div class="btn-lock">
          <i id="lock" class="fas fa-lock" onclick="drawflowEditor.editor_mode='fixed'; changeMode('lock');"></i>
          <i id="unlock" class="fas fa-lock-open" onclick="drawflowEditor.editor_mode='edit'; changeMode('unlock');" style="display:none;"></i>
        </div>
        <div class="bar-zoom">
          <i class="fas fa-search-minus" onclick="drawflowEditor.zoom_out()"></i>
          <i class="fas fa-search" onclick="drawflowEditor.zoom_reset()"></i>
          <i class="fas fa-search-plus" onclick="drawflowEditor.zoom_in()"></i>
        </div>        
      </div>
    </div>
  </div>

  <svg width="0" height="0">
    <defs>
      <marker id="arrowhead" markerWidth="10" markerHeight="7" 
        refX="10" refY="3.5" orient="auto">
        <polygon points="0 0, 10 3.5, 0 7" fill="#4ea9ff"/>
      </marker>
    </defs>
  </svg>
  
  <script>
let isNewSchema = false;
let drawflowEditor = null;
let currentSchemaId = null;
const createdNodeTypes = new Map();

window.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById("drawflow");
    drawflowEditor = new Drawflow(container);
    
    drawflowEditor.reroute = true;
    drawflowEditor.reroute_fix_curvature = true;
    drawflowEditor.force_first_input = false;

    // Eigenfunction of curvature
    drawflowEditor.createCurvature = function(start_pos_x, start_pos_y, end_pos_x, end_pos_y, curvature_value, type) {
        const hx1 = start_pos_x + Math.abs(end_pos_x - start_pos_x) * curvature_value;
        const hx2 = end_pos_x - Math.abs(end_pos_x - start_pos_x) * curvature_value;
        return `M ${start_pos_x} ${start_pos_y} C ${hx1} ${start_pos_y}, ${hx2} ${end_pos_y}, ${end_pos_x} ${end_pos_y}`;
    }

    drawflowEditor.curvature = 0.5;

    drawflowEditor.start();

    drawflowEditor.on('nodeCreated', () => {
        autoUpdateSchema();
        initializeAllTextareas(); // <== Add auto-initialization of textarea after node creation
    });

    function bindDfInputsToNodeData(nodeId) {
    const nodeElement = document.querySelector(`#node-${nodeId}`);
    if (!nodeElement) return;

    const dfInputs = nodeElement.querySelectorAll('[df-name], [df-course], [df-credits]');

    dfInputs.forEach(input => {
        const attr = Array.from(input.attributes).find(attr => attr.name.startsWith('df-'));
        if (!attr) return;

        const dataKey = attr.name.replace('df-', '');

        input.addEventListener('input', (e) => {
            drawflowEditor.drawflow.Home.data[nodeId].data[dataKey] = e.target.value;
        });
    });
}

    drawflowEditor.on('nodeCreated', (id) => {
    bindDfInputsToNodeData(id);
});

    // Automatic saving on changes
    drawflowEditor.on('nodeCreated', autoUpdateSchema);
    drawflowEditor.on('nodeRemoved', autoUpdateSchema);
    drawflowEditor.on('connectionCreated', autoUpdateSchema);
    drawflowEditor.on('connectionRemoved', autoUpdateSchema);
    drawflowEditor.on('nodeMoved', autoUpdateSchema);

    // Events to log
    drawflowEditor.on('nodeSelected', id => console.log("Node selected", id));
    drawflowEditor.on('moduleCreated', name => console.log("Module Created", name));
    drawflowEditor.on('moduleChanged', name => console.log("Module Changed", name));
    drawflowEditor.on('zoom', zoom => console.log('Zoom level', zoom));
    drawflowEditor.on('translate', pos => console.log('Translate', pos));
    drawflowEditor.on('addReroute', id => console.log('Reroute added', id));
    drawflowEditor.on('removeReroute', id => console.log('Reroute removed', id));

    // Autosave when changing name
    document.querySelector('.title-input').addEventListener('input', () => {
        autoUpdateSchema();
    });

    // Load button list at startup
    loadSchemaButtons();

    const lastSchemaId = localStorage.getItem('lastOpenedSchemaId');
    if (lastSchemaId) {
    loadSchemaFromServer(lastSchemaId);
    }

    const lastId = localStorage.getItem('lastOpenedSchemaId');
    if (lastId) {
        loadSchemaFromServer(lastId); // this call will already highlight the button
    }

    // Binding the Delete button to a function
    const clearBtn = document.querySelector('.btn-clear');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            deleteCurrentSchema();
        });
    }

    document.querySelector('.btn-save-schema').disabled = false;
    document.querySelector('.btn-new-schema').disabled = true;
    document.getElementById('btnExport').disabled = true;
    document.getElementById('btnImport').disabled = false;

    drawflowEditor.on('nodeRemoved', function (id) {
    console.log('Node removed with id:', id);
    const nodeName = createdNodeTypes.get(Number(id));
    console.log('Node type:', nodeName);
    console.log("Current node map:", Array.from(createdNodeTypes.entries()));

    if (!nodeName || nodeName === 'blank') return;

    const sidebarItem = document.querySelector(`.drag-drawflow[data-node="${nodeName}"]`);
    if (!sidebarItem) {
        console.warn(`No node found in the sidebar for type: ${nodeName}`);
        return;
    }

    sidebarItem.style.removeProperty('display');

    createdNodeTypes.delete(id);
});

    requestAnimationFrame(() => {
        initializeAllTextareas();
    });
});

function updateDeleteButtonState() {
  const deleteButton = document.querySelector('.btn-clear');
  const isEditorEmpty = Object.keys(drawflowEditor.export().drawflow.Home.data).length === 0;
  deleteButton.disabled = isEditorEmpty;
}

function isEditorEmpty() {
  const data = drawflowEditor.export();
  return Object.keys(data.drawflow.Home.data).length === 0;
}

function newSchema() {
  drawflowEditor.clear();
  document.querySelector('.btn-save-schema').disabled = false;

  // Activate the "Delete" button, even if the diagram is empty
  const deleteButton = document.querySelector('.btn-clear');
  deleteButton.disabled = false;
  deleteButton.classList.remove('disabled');
}

function highlightActiveButton(activeId) {
    const buttons = document.querySelectorAll('#schema-buttons button');
    console.log('--- highlighting ---');
    console.log('activeId:', activeId);
    buttons.forEach(btn => {
        if (btn.dataset.id === String(activeId)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
        console.log('button id:', btn.dataset.id);
    });
}

function clearButtonHighlight() {
    const buttons = document.querySelectorAll('#schema-buttons button');
    buttons.forEach(btn => btn.classList.remove('active'));
}

let activeCourse = null;

function highlightCourse(courseNumber) {
  const buttons = document.querySelectorAll(".btn-course");

  // Remove active class from all buttons
  buttons.forEach(btn => btn.classList.remove("active-btn"));

  if (activeCourse === courseNumber) {
    document.querySelectorAll(".drawflow-node").forEach(node => {
      node.classList.remove("highlighted-course");
    });
    activeCourse = null;
    return;
  }

  document.querySelectorAll(".drawflow-node").forEach(node => {
    node.classList.remove("highlighted-course");
  });

  document.querySelectorAll(".drawflow-node").forEach(node => {
    const courseInput = node.querySelector("input[type='text']");
    if (courseInput && courseInput.value.trim() === courseNumber) {
      node.classList.add("highlighted-course");
    }
  });

  // Add active class to clicked button
  const clickedButton = Array.from(buttons).find(btn => btn.textContent.includes(courseNumber));
  if (clickedButton) {
    clickedButton.classList.add("active-btn");
  }

  activeCourse = courseNumber;
}

async function checkUnsavedNewSchemaBeforeLoad() {
    if (!currentSchemaId) {
        const currentData = drawflowEditor.export();
        const currentNodes = currentData.drawflow?.Home?.data || {};

        if (Object.keys(currentNodes).length > 0) {
            const result = await Swal.fire({
                title: 'Save the diagram?',
                text: 'You have created a new diagram but have not saved it yet. Save before opening another?',
                icon: 'warning',
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'Yes, save',
                denyButtonText: 'No, don\'t save',
                cancelButtonText: 'Cancel',
                background: '#fffaf0',
                confirmButtonColor: '#3085d6',
                denyButtonColor: '#f0ad4e',
                cancelButtonColor: '#d33',
                customClass: {
                    title: 'swal2-title-custom',
                    popup: 'swal2-popup-custom',
                    confirmButton: 'swal2-confirm-custom',
                    denyButton: 'swal2-deny-custom',
                    cancelButton: 'swal2-cancel-custom'
                }
            });

            if (result.isConfirmed) {
                await saveSchema();
                return 'save';
            } else if (result.isDenied) {
                return 'nosave';
            } else if (result.isDismissed) {
                return 'cancel';
            }
        }
    }
    return 'nosave'; // Nothing has changed - you can continue without saving
}

function initializeAutoSaveOnInput() {
    const textareas = document.querySelectorAll('.drawflow .node textarea, .drawflow .node input');

    textareas.forEach(el => {
        el.removeEventListener('input', autoUpdateSchema); // avoiding duplication
        el.addEventListener('input', () => {
            autoUpdateSchema(); // saving with each input
        });
    });
}

async function loadSchemaFromServer(schemaId) {
  const action = await checkUnsavedNewSchemaBeforeLoad();
    
    if (action === 'cancel') {
        drawflowEditor.clear();
    }

    if (action !== 'cancel' && action !== 'save' && action !== 'nosave') {
        console.error('Unknown action variant:', action);
        return;
    }
    fetch(`http://localhost:3000/get-schema/${schemaId}`)
    .then(response => response.json())
    .then(data => {
        drawflowEditor.clear();
        isNewSchema = false;
        drawflowEditor.import(data.schemaData);

        const titleInput = document.querySelector('.title-input');
        titleInput.value = data.title;
        localStorage.setItem(`schemaTitle_${schemaId}`, data.title);

        document.querySelector('.btn-save-schema').disabled = true;
        document.querySelector('.btn-new-schema').disabled = false;
        document.getElementById('btnExport').disabled = false;
        document.getElementById('btnImport').disabled = true;

        currentSchemaId = schemaId;
        localStorage.setItem('lastOpenedSchemaId', schemaId);
        console.log('The diagram is loaded:', data.title);
        highlightActiveButton(schemaId);
        updateDeleteButtonState();

        // Bind onblur separately:
        document.querySelector('.title-input').onblur = () => handleTitleBlur(schemaId);

        setTimeout(() => {
            initializeAllTextareas();
            initializeAllInputs();
            initializeAutoSaveOnInput();
        }, 0);
        const allNodeTypes = [
    'programming',
    'operation_sys',
    'math_analysis',
    'algebra_geo',
    'praktika',
    'ukr_lang',
    'ukr_history',
    'foreign_lang',
    'pidpriem',
    'ekologiya',
    'diferential_eq',
    'theory_of_probability',
    'diskret_math',
    'physics',
    'math_logic',
    'object_oriented_programming',
    'database',
    'web_programming',
    'mikrocontrollers',
    'electronics',
    'course_work_sys_prog',
    'sensors_and_actuators',
    'computer_networks',
    'information_security',
    'course_work_prog',
    'math_physics',
    'machine_learning',
    'arduino_dev',
    'internet_of_things',
    'course_work_internet_of_things',
    'people_machine_interaction',
    'construction_of_software',
    'management_quality_of_software',
    'business_analytics',
    'bachelor_work',
    'prod_pract'
];

// Clear node type map
createdNodeTypes.clear();

// Determine which types are already in the diagram
const usedNodeTypes = new Set();

const nodes = data.schemaData.drawflow?.Home?.data || {};
for (const nodeId in nodes) {
    const nodeData = nodes[nodeId];
    const type = nodeData.name;

    // Restore original type map
    const originalType = Object.entries({
        'prog': 'programming',
        'sys': 'operation_sys',
        'math_an': 'math_analysis',
        'algb_geo': 'algebra_geo',
        'prakt': 'praktika',
        'ukr': 'ukr_lang',
        'ukr_hist': 'ukr_history',
        'for_lang': 'foreign_lang',
        'pidpr': 'pidpriem',
        'ekol': 'ekologiya',
        'dif_eq': 'diferential_eq',
        'theor_prob': 'theory_of_probability',
        'diskret_math': 'diskret_math',
        'phys': 'physics',
        'math_log': 'math_logic',
        'obj_or_pr': 'object_oriented_programming',
        'db': 'database',
        'web_prog': 'web_programming',
        'mikrocont': 'mikrocontrollers',
        'elektron': 'electronics',
        'kursov_sys_prog': 'course_work_sys_prog',
        'sens_act': 'sensors_and_actuators',
        'comp_net': 'computer_networks',
        'info_sec': 'information_security',
        'kursov_prog': 'course_work_prog',
        'math_phys': 'math_physics',
        'mach_learn': 'machine_learning',
        'arduino_dev': 'arduino_dev',
        'internet_of_things': 'internet_of_things',
        'kursov_internet_of_things': 'course_work_internet_of_things',
        'people_machine_interaction': 'people_machine_interaction',
        'construction_of_software': 'construction_of_software',
        'management_quality_of_software': 'management_quality_of_software',
        'business_analytics': 'business_analytics',
        'bachelor_work': 'bachelor_work',
        'prod_pract': 'prod_pract'
    }).find(([short, full]) => short === type);

    if (originalType) {
        usedNodeTypes.add(originalType[1]);
        createdNodeTypes.set(Number(nodeId), originalType[1]);
    }
}

// Show/hide nodes in the sidebar
allNodeTypes.forEach(nodeType => {
    const sidebarItem = document.querySelector(`.drag-drawflow[data-node="${nodeType}"]`);
    if (sidebarItem) {
        sidebarItem.style.display = usedNodeTypes.has(nodeType) ? 'none' : '';
    }
})
    })
    .catch(error => {
        console.error('Error loading diagram:', error);
    });
}

function handleTitleBlur(schemaId) {
    const titleInput = document.querySelector('.title-input');
    const currentTitle = titleInput.value.trim();

    // Check only for saved diagrams
    if (!isNewSchema && schemaId) {
        if (currentTitle === '') {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'The diagram name cannot be empty!',
                confirmButtonText: 'OK'
            }).then(() => {
                const savedTitle = localStorage.getItem(`schemaTitle_${schemaId}`) || '–ë–µ–∑ –Ω–∞–∑–≤–∏';
                titleInput.value = savedTitle;

                const button = document.querySelector(`button[data-id='${schemaId}']`);
                if (button) button.textContent = savedTitle;

                autoUpdateSchema();
            });
            return;
        }

        localStorage.setItem(`schemaTitle_${schemaId}`, currentTitle);

        const button = document.querySelector(`button[data-id='${schemaId}']`);
        if (button) button.textContent = currentTitle;

        autoUpdateSchema();
    }
}

async function saveSchema() {
    const schemaData = drawflowEditor.export();
    const nodes = schemaData.drawflow?.Home?.data || {};

    if (Object.keys(nodes).length === 0) {
        Swal.fire({
            title: 'The diagram is empty!',
            text: 'Add at least one block before saving.',
            icon: 'warning',
            confirmButtonText: 'OK',
            background: '#fff8f0',
            confirmButtonColor: '#d33',
            customClass: {
                title: 'swal2-title-custom',
                popup: 'swal2-popup-custom',
                confirmButton: 'swal2-confirm-custom'
            }
        });
        return; // Stop function execution
    }

    let inputTitle = document.querySelector('.title-input').value.trim();

    if (!currentSchemaId) {
        let result;

        if (inputTitle) {
            // If the user has already entered something ‚Äî confirmation
            result = await Swal.fire({
            title: 'Confirm diagram name',
            input: 'text',
            inputValue: inputTitle,
            icon: 'question',
            background: '#f0f8ff',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel',
            showCancelButton: true,
            customClass: {
            title: 'swal2-title-custom',
            input: 'swal2-input-custom',
            popup: 'swal2-popup-custom',
            confirmButton: 'swal2-confirm-custom',
            cancelButton: 'swal2-cancel-custom'
          },
          inputValidator: (value) => {
          if (!value) return 'The name cannot be empty!';
          }
          });
        } else {
            // If the name has not been entered yet ‚Äî request
            result = await Swal.fire({
            title: 'Enter the name of the new diagram',
            input: 'text',
            icon: 'info',
            background: '#f0f8ff',
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Save',
            cancelButtonText: 'Cancel',
            showCancelButton: true,
            customClass: {
            title: 'swal2-title-custom',
            input: 'swal2-input-custom',
            popup: 'swal2-popup-custom',
            confirmButton: 'swal2-confirm-custom',
            cancelButton: 'swal2-cancel-custom'
          },
          inputValidator: (value) => {
          if (!value) return 'The name cannot be empty!';
          }
          });
        }
        if (result.isConfirmed) {
            const title = result.value;

            fetch('http://localhost:3000/save-schema', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, schemaData })
            })
            .then(res => res.json())
            .then(data => {
                currentSchemaId = data.id;
                document.querySelector('.title-input').value = title;
                addSchemaButton(data.id, title);
                highlightActiveButton(data.id);
                document.querySelector('.btn-new-schema').disabled = false;
                document.querySelector('.btn-save-schema').disabled = true;
                // Activate Export, deactivate Import
                document.getElementById('btnExport').disabled = false;
                document.getElementById('btnImport').disabled = true;
                console.log('New diagram saved');
                updateDeleteButtonState();
            })
            .catch(err => console.error('Error saving diagram:', err));
        }

    } else {
        // Updating existing diagram
        const title = inputTitle;

        fetch(`http://localhost:3000/update-schema/${currentSchemaId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, schemaData })
        })
        .then(res => res.json())
        .then(() => {
            const btn = document.querySelector(`button[data-id='${currentSchemaId}']`);
            if (btn) btn.textContent = title;
            console.log('Diagram updated');
        })
        .catch(err => console.error('Error updating diagram:', err));
    }
}

async function startNewSchema() {
  const result = await Swal.fire({
    title: 'Clear the editor?',
    text: 'This action will clear the editor for working with a new diagram. The current diagram will be saved.',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, clear it',
    cancelButtonText: 'Cancel',
    background: '#fffaf0',
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33',
    customClass: {
      title: 'swal2-title-custom',
      popup: 'swal2-popup-custom',
      confirmButton: 'swal2-confirm-custom',
      cancelButton: 'swal2-cancel-custom'
    }
  });

  if (result.isConfirmed) {
    drawflowEditor.clear();
    document.querySelector('.title-input').value = '';
    currentSchemaId = null;
    isNewSchema = true;
    localStorage.removeItem('lastOpenedSchemaId');
    document.querySelector('.btn-save-schema').disabled = false;
    document.querySelector('.btn-new-schema').disabled = true;
    document.getElementById('btnImport').disabled = false;
    document.getElementById('btnExport').disabled = true;
    updateDeleteButtonState();
    clearButtonHighlight();
    resetSidebarNodes();
  }
}

function autoUpdateSchema() {
    if (!currentSchemaId) return;

    const updatedData = drawflowEditor.export();
    const newTitle = document.querySelector('.title-input').value;

    fetch(`http://localhost:3000/update-schema/${currentSchemaId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: newTitle, schemaData: updatedData })
    }).then(res => res.json())
    .then(data => {
        console.log('The diagram is updated automatically.');
        const btn = document.querySelector(`button[data-id='${currentSchemaId}']`);
        if (btn) btn.textContent = newTitle;
    })
    .catch(err => console.error('Error updating diagram:', err));
}

function addSchemaButton(id, title) {
    const container = document.getElementById('schema-buttons');
    const btn = document.createElement('button');
    btn.textContent = title;
    btn.dataset.id = id;
    btn.addEventListener('click', () => {
    loadSchemaFromServer(id);
    });
    container.appendChild(btn);
}

function loadSchemaButtons() {
    fetch('http://localhost:3000/get-all-schemas')
    .then(res => res.json())
    .then(schemas => {
        const container = document.getElementById('schema-buttons');
        container.innerHTML = '';
        schemas.forEach(schema => {
            addSchemaButton(schema.id, schema.title);
        });
    })
    .catch(err => console.error('Error loading schema buttons:', err));
}

async function deleteCurrentSchema() {
  if (!currentSchemaId) return;

  const result = await Swal.fire({
    title: 'Delete diagram?',
    text: 'This action cannot be undone!',
    icon: 'warning',
    showCancelButton: true,
    confirmButtonText: 'Yes, delete it',
    cancelButtonText: 'Cancel',
    background: '#fffaf0',
    confirmButtonColor: '#d33',
    cancelButtonColor: '#3085d6',
    customClass: {
      title: 'swal2-title-custom',
      popup: 'swal2-popup-custom',
      confirmButton: 'swal2-confirm-custom',
      cancelButton: 'swal2-cancel-custom'
    }
  });

  if (result.isConfirmed) {
    fetch(`http://localhost:3000/delete-schema/${currentSchemaId}`, {
      method: 'DELETE'
    })
      .then(res => res.json())
      .then(() => {
        drawflowEditor.clear();
        document.querySelector('.title-input').value = '';
        const btn = document.querySelector(`button[data-id='${currentSchemaId}']`);
        if (btn) btn.remove();
        currentSchemaId = null;
        updateDeleteButtonState();
        document.querySelector('.btn-new-schema').disabled = true;
        document.querySelector('.btn-save-schema').disabled = false;
        document.getElementById('btnImport').disabled = false;
        document.getElementById('btnExport').disabled = true;
        resetSidebarNodes();
        console.log('The diagram is deleted successfully.');
      })
      .catch(err => {
        console.error('Error deleting diagram:', err);
      });
  }
}

document.querySelector('.btn-clear').addEventListener('click', deleteCurrentSchema);

function resetSidebarNodes() {
  const allSidebarItems = document.querySelectorAll('.drag-drawflow');
  allSidebarItems.forEach(item => {
    item.style.display = '';
  });

  createdNodeTypes.clear();
}

function toggleSidebarInfo() {
  const content = document.getElementById('sidebarContent');
  const header = document.getElementById('infoHeader');

  const isExpanded = content.classList.toggle('expanded');
  content.classList.toggle('collapsed', !isExpanded);
  header.classList.toggle('active', isExpanded);
}

function toggleSubjectsList() {
  const list = document.getElementById('subjectsList');
  const header = document.getElementById('subjectsHeader');

  const isExpanded = list.classList.toggle('expanded');
  list.classList.toggle('collapsed', !isExpanded);
  header.classList.toggle('active', isExpanded);
}

    /* DRAG EVENT */

    /* Mouse and Touch Actions */

    var elements = document.getElementsByClassName('drag-drawflow');
    for (var i = 0; i < elements.length; i++) {
      elements[i].addEventListener('touchend', drop, false);
      elements[i].addEventListener('touchmove', positionMobile, false);
      elements[i].addEventListener('touchstart', drag, false );
    }

    var mobile_item_selec = '';
    var mobile_last_move = null;
   function positionMobile(ev) {
     mobile_last_move = ev;
   }

   function allowDrop(ev) {
      ev.preventDefault();
    }

    function drag(ev) {
      if (ev.type === "touchstart") {
        mobile_item_selec = ev.target.closest(".drag-drawflow").getAttribute('data-node');
      } else {
      ev.dataTransfer.setData("node", ev.target.getAttribute('data-node'));
      }
    }

    function drop(ev) {
      if (ev.type === "touchend") {
        var parentdrawflow = document.elementFromPoint( mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY).closest("#drawflow");
        if(parentdrawflow != null) {
          addNodeToDrawFlow(mobile_item_selec, mobile_last_move.touches[0].clientX, mobile_last_move.touches[0].clientY);
        }
        mobile_item_selec = '';
      } else {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("node");
        addNodeToDrawFlow(data, ev.clientX, ev.clientY);
      }
    }

    function autoResizeTextarea(textarea) {
    textarea.style.height = "auto"; // First, we drop the height.
    textarea.style.height = textarea.scrollHeight + "px"; // We set the new height according to the content
}

// Function to add a node
function addNodeToDrawFlow(name, pos_x, pos_y) {
    if (drawflowEditor.editor_mode === 'fixed') {
        return false;
    }

    pos_x = pos_x * (drawflowEditor.precanvas.clientWidth / (drawflowEditor.precanvas.clientWidth * drawflowEditor.zoom)) - (drawflowEditor.precanvas.getBoundingClientRect().x * (drawflowEditor.precanvas.clientWidth / (drawflowEditor.precanvas.clientWidth * drawflowEditor.zoom)));
    pos_y = pos_y * (drawflowEditor.precanvas.clientHeight / (drawflowEditor.precanvas.clientHeight * drawflowEditor.zoom)) - (drawflowEditor.precanvas.getBoundingClientRect().y * (drawflowEditor.precanvas.clientHeight / (drawflowEditor.precanvas.clientHeight * drawflowEditor.zoom)));

    let nodeId = null;

    switch (name) {
        case 'blank':
            nodeId = drawflowEditor.addNode(
                'blank',
                1,
                1,
                pos_x,
                pos_y,
                'blank',
                {"course": "",
                 "credits": ""
                 },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline"></textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" df-course />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" df-credits />
                        </div>
                    </div>
                </div>`
            );
            setTimeout(() => {
                bindDfInputsToNodeData(nodeId);
                initializeAutoSaveOnInput();
                initializeAllTextareas();
                initializeAllInputs();
            }, 0);
            break;
        case 'programming':
        const defaultDiscipline = "Programming";
        const defaultCourse = "1";
        const defaultCredits = "10";
            nodeId = drawflowEditor.addNode(
                'prog',
                1,
                1,
                pos_x,
                pos_y,
                'prog',
                { "text": defaultDiscipline,
                  "course": defaultCourse,
                  "credits": defaultCredits
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'programming');
            break;
            case 'operation_sys':
            const defaultDiscipline_1 = "Operating Systems";
            const defaultCourse_1 = "1";
            const defaultCredits_1 = "5";
            nodeId = drawflowEditor.addNode(
                'sys',
                1,
                1,
                pos_x,
                pos_y,
                'sys',
                { "text": defaultDiscipline_1,
                  "course": defaultCourse_1,
                  "credits": defaultCredits_1
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_1}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_1}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_1}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'operation_sys');
            break;
            case 'math_analysis':
            const defaultDiscipline_2 = "Mathematical Analysis";
            const defaultCourse_2 = "1";
            const defaultCredits_2 = "10";
            nodeId = drawflowEditor.addNode(
                'math_an',
                1,
                1,
                pos_x,
                pos_y,
                'math_an',
                { "text": defaultDiscipline_2,
                  "course": defaultCourse_2,
                  "credits": defaultCredits_2
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_2}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_2}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_2}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'math_analysis');
            break;
            case 'algebra_geo':
            const defaultDiscipline_3 = "Algebra and Geometry";
            const defaultCourse_3 = "1";
            const defaultCredits_3 = "8";
            nodeId = drawflowEditor.addNode(
                'algb_geo',
                1,
                1,
                pos_x,
                pos_y,
                'algb_geo',
                { "text": defaultDiscipline_3,
                  "course": defaultCourse_3,
                  "credits": defaultCredits_3
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_3}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_3}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_3}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'algebra_geo');
            break;
            case 'praktika':
            const defaultDiscipline_4 = "Software Engineering Workshop";
            const defaultCourse_4 = "1";
            const defaultCredits_4 = "6";
            nodeId = drawflowEditor.addNode(
                'prakt',
                1,
                1,
                pos_x,
                pos_y,
                'prakt',
                { "text": defaultDiscipline_4,
                  "course": defaultCourse_4,
                  "credits": defaultCredits_4
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_4}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_4}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_4}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'praktika');
            break;
            case 'ukr_lang':
            const defaultDiscipline_5 = "Ukrainian Language (for Professional Purposes)";
            const defaultCourse_5 = "1";
            const defaultCredits_5 = "3";
            nodeId = drawflowEditor.addNode(
                'ukr',
                1,
                1,
                pos_x,
                pos_y,
                'ukr',
                { "text": defaultDiscipline_5,
                  "course": defaultCourse_5,
                  "credits": defaultCredits_5
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_5}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_5}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_5}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'ukr_lang');
            break;
            case 'ukr_history':
            const defaultDiscipline_6 = "Ukrainian Statehood and Culture";
            const defaultCourse_6 = "1";
            const defaultCredits_6 = "4";
            nodeId = drawflowEditor.addNode(
                'ukr_hist',
                1,
                1,
                pos_x,
                pos_y,
                'ukr_hist',
                { "text": defaultDiscipline_6,
                  "course": defaultCourse_6,
                  "credits": defaultCredits_6
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_6}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_6}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_6}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'ukr_history');
            break;
            case 'foreign_lang':
            const defaultDiscipline_7 = "Foreign language";
            const defaultCourse_7 = "1";
            const defaultCredits_7 = "12";
            nodeId = drawflowEditor.addNode(
                'for_lang',
                1,
                1,
                pos_x,
                pos_y,
                'for_lang',
                { "text": defaultDiscipline_7,
                  "course": defaultCourse_7,
                  "credits": defaultCredits_7
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_7}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_7}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_7}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'foreign_lang');
            break;
            case 'pidpriem':
            const defaultDiscipline_8 = "Entrepreneurial activity";
            const defaultCourse_8 = "4";
            const defaultCredits_8 = "3";
            nodeId = drawflowEditor.addNode(
                'pidpr',
                1,
                1,
                pos_x,
                pos_y,
                'pidpr',
                { "text": defaultDiscipline_8,
                  "course": defaultCourse_8,
                  "credits": defaultCredits_8
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_8}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_8}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_8}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'pidpriem');
            break;
            case 'ekologiya':
            const defaultDiscipline_8_1 = "Ecology";
            const defaultCourse_8_1 = "1";
            const defaultCredits_8_1 = "3";
            nodeId = drawflowEditor.addNode(
                'ekol',
                1,
                1,
                pos_x,
                pos_y,
                'ekol',
                { "text": defaultDiscipline_8_1,
                  "course": defaultCourse_8_1,
                  "credits": defaultCredits_8_1
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_8_1}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_8_1}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_8_1}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'ekologiya');
            break;
            case 'diferential_eq':
            const defaultDiscipline_9 = "Differential equations";
            const defaultCourse_9 = "2";
            const defaultCredits_9 = "4";
            nodeId = drawflowEditor.addNode(
                'dif_eq',
                1,
                1,
                pos_x,
                pos_y,
                'dif_eq',
                { "text": defaultDiscipline_9,
                  "course": defaultCourse_9,
                  "credits": defaultCredits_9
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_9}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_9}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_9}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'diferential_eq');
            break;
            case 'theory_of_probability':
            const defaultDiscipline_10 = "Probability theory and mathematical statistics";
            const defaultCourse_10 = "2";
            const defaultCredits_10 = "4,5";
            nodeId = drawflowEditor.addNode(
                'theor_prob',
                1,
                1,
                pos_x,
                pos_y,
                'theor_prob',
                { "text": defaultDiscipline_10,
                  "course": defaultCourse_10,
                  "credits": defaultCredits_10
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_10}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_10}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_10}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'theory_of_probability');
            break;
            case 'diskret_math':
            const defaultDiscipline_11 = "Computer discrete mathematics";
            const defaultCourse_11 = "2";
            const defaultCredits_11 = "4";
            nodeId = drawflowEditor.addNode(
                'diskret_math',
                1,
                1,
                pos_x,
                pos_y,
                'diskret_math',
                { "text": defaultDiscipline_11,
                  "course": defaultCourse_11,
                  "credits": defaultCredits_11
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_11}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_11}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_11}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'diskret_math');
            break;
            case 'physics':
            const defaultDiscipline_12 = "Physics";
            const defaultCourse_12 = "2";
            const defaultCredits_12 = "4,5";
            nodeId = drawflowEditor.addNode(
                'phys',
                1,
                1,
                pos_x,
                pos_y,
                'phys',
                { "text": defaultDiscipline_12,
                  "course": defaultCourse_12,
                  "credits": defaultCredits_12
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_12}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_12}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_12}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'physics');
            break;
            case 'math_logic':
            const defaultDiscipline_13 = "Mathematical logic, algorithm theory and programming";
            const defaultCourse_13 = "1";
            const defaultCredits_13 = "5";
            nodeId = drawflowEditor.addNode(
                'math_log',
                1,
                1,
                pos_x,
                pos_y,
                'math_log',
                { "text": defaultDiscipline_13,
                  "course": defaultCourse_13,
                  "credits": defaultCredits_13
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_13}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_13}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_13}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'math_logic');
            break;
            case 'object_oriented_programming':
            const defaultDiscipline_14 = "Object-oriented programming and design patterns";
            const defaultCourse_14 = "2";
            const defaultCredits_14 = "6";
            nodeId = drawflowEditor.addNode(
                'obj_or_pr',
                1,
                1,
                pos_x,
                pos_y,
                'obj_or_pr',
                { "text": defaultDiscipline_14,
                  "course": defaultCourse_14,
                  "credits": defaultCredits_14
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_14}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_14}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_14}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'object_oriented_programming');
            break;
            case 'database':
            const defaultDiscipline_15 = "Databases";
            const defaultCourse_15 = "2";
            const defaultCredits_15 = "4,5";
            nodeId = drawflowEditor.addNode(
                'db',
                1,
                1,
                pos_x,
                pos_y,
                'db',
                { "text": defaultDiscipline_15,
                  "course": defaultCourse_15,
                  "credits": defaultCredits_15
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_15}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_15}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_15}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'database');
            break;
            case 'web_programming':
            const defaultDiscipline_16 = "Web programming and cloud technologies";
            const defaultCourse_16 = "2";
            const defaultCredits_16 = "4,5";
            nodeId = drawflowEditor.addNode(
                'web_prog',
                1,
                1,
                pos_x,
                pos_y,
                'web_prog',
                { "text": defaultDiscipline_16,
                  "course": defaultCourse_16,
                  "credits": defaultCredits_16
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_16}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_16}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_16}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'web_programming');
            break;
            case 'mikrocontrollers':
            const defaultDiscipline_17 = "Microcontrollers and system programming";
            const defaultCourse_17 = "3";
            const defaultCredits_17 = "5";
            nodeId = drawflowEditor.addNode(
                'mikrocont',
                1,
                1,
                pos_x,
                pos_y,
                'mikrocont',
                { "text": defaultDiscipline_17,
                  "course": defaultCourse_17,
                  "credits": defaultCredits_17
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_17}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_17}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_17}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'mikrocontrollers');
            break;
            case 'electronics':
            const defaultDiscipline_18 = "Electrical Engineering and Computer Electronics";
            const defaultCourse_18 = "2";
            const defaultCredits_18 = "4";
            nodeId = drawflowEditor.addNode(
                'elektron',
                1,
                1,
                pos_x,
                pos_y,
                'elektron',
                { "text": defaultDiscipline_18,
                  "course": defaultCourse_18,
                  "credits": defaultCredits_18
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_18}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_18}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_18}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'electronics');
            break;
            case 'course_work_sys_prog':
            const defaultDiscipline_19 = "System Programming Coursework";
            const defaultCourse_19 = "3";
            const defaultCredits_19 = "3";
            nodeId = drawflowEditor.addNode(
                'kursov_sys_prog',
                1,
                1,
                pos_x,
                pos_y,
                'kursov_sys_prog',
                { "text": defaultDiscipline_19,
                  "course": defaultCourse_19,
                  "credits": defaultCredits_19
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_19}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_19}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_19}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'course_work_sys_prog');
            break;
            case 'sensors_and_actuators':
            const defaultDiscipline_20 = "Sensors and actuators";
            const defaultCourse_20 = "3";
            const defaultCredits_20 = "4,5";
            nodeId = drawflowEditor.addNode(
                'sens_act',
                1,
                1,
                pos_x,
                pos_y,
                'sens_act',
                { "text": defaultDiscipline_20,
                  "course": defaultCourse_20,
                  "credits": defaultCredits_20
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_20}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_20}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_20}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'sensors_and_actuators');
            break;
            case 'computer_networks':
            const defaultDiscipline_21 = "Computer networks, interfaces and data transfer protocols";
            const defaultCourse_21 = "2";
            const defaultCredits_21 = "4,5";
            nodeId = drawflowEditor.addNode(
                'comp_net',
                1,
                1,
                pos_x,
                pos_y,
                'comp_net',
                { "text": defaultDiscipline_21,
                  "course": defaultCourse_21,
                  "credits": defaultCredits_21
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_21}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_21}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_21}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'computer_networks');
            break;
            case 'information_security':
            const defaultDiscipline_22 = "Information systems security and information protection";
            const defaultCourse_22 = "3";
            const defaultCredits_22 = "5";
            nodeId = drawflowEditor.addNode(
                'info_sec',
                1,
                1,
                pos_x,
                pos_y,
                'info_sec',
                { "text": defaultDiscipline_22,
                  "course": defaultCourse_22,
                  "credits": defaultCredits_22
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_22}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_22}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_22}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'information_security');
            break;
            case 'course_work_prog':
            const defaultDiscipline_23 = "Programming coursework";
            const defaultCourse_23 = "2";
            const defaultCredits_23 = "3";
            nodeId = drawflowEditor.addNode(
                'kursov_prog',
                1,
                1,
                pos_x,
                pos_y,
                'kursov_prog',
                { "text": defaultDiscipline_23,
                  "course": defaultCourse_23,
                  "credits": defaultCredits_23
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_23}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_23}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_23}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'course_work_prog');
            break;
            case 'math_physics':
            const defaultDiscipline_24 = "Algorithms and computational methods of mathematical physics";
            const defaultCourse_24 = "3";
            const defaultCredits_24 = "4";
            nodeId = drawflowEditor.addNode(
                'math_phys',
                1,
                1,
                pos_x,
                pos_y,
                'math_phys',
                { "text": defaultDiscipline_24,
                  "course": defaultCourse_24,
                  "credits": defaultCredits_24
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_24}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_24}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_24}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'math_physics');
            break;
            case 'machine_learning':
            const defaultDiscipline_25 = "Machine learning and computational intelligence methods";
            const defaultCourse_25 = "3";
            const defaultCredits_25 = "3";
            nodeId = drawflowEditor.addNode(
                'mach_learn',
                1,
                1,
                pos_x,
                pos_y,
                'mach_learn',
                { "text": defaultDiscipline_25,
                  "course": defaultCourse_25,
                  "credits": defaultCredits_25
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_25}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_25}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_25}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'machine_learning');
            break;
            case 'arduino_dev':
            const defaultDiscipline_26 = "Arduino-based device development";
            const defaultCourse_26 = "3";
            const defaultCredits_26 = "4";
            nodeId = drawflowEditor.addNode(
                'arduino_dev',
                1,
                1,
                pos_x,
                pos_y,
                'arduino_dev',
                { "text": defaultDiscipline_26,
                  "course": defaultCourse_26,
                  "credits": defaultCredits_26
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_26}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_26}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_26}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'arduino_dev');
            break;
            case 'internet_of_things':
            const defaultDiscipline_27 = "Design, construction and reliability of the Internet of Things";
            const defaultCourse_27 = "4";
            const defaultCredits_27 = "5";
            nodeId = drawflowEditor.addNode(
                'internet_of_things',
                1,
                1,
                pos_x,
                pos_y,
                'internet_of_things',
                { "text": defaultDiscipline_27,
                  "course": defaultCourse_27,
                  "credits": defaultCredits_27
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_27}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_27}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_27}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'internet_of_things');
            break;
            case 'course_work_internet_of_things':
            const defaultDiscipline_28 = "Internet of Things Programming Coursework";
            const defaultCourse_28 = "4";
            const defaultCredits_28 = "3";
            nodeId = drawflowEditor.addNode(
                'kursov_internet_of_things',
                1,
                1,
                pos_x,
                pos_y,
                'kursov_internet_of_things',
                { "text": defaultDiscipline_28,
                  "course": defaultCourse_28,
                  "credits": defaultCredits_28
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_28}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_28}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_28}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'course_work_internet_of_things');
            break;
            case 'people_machine_interaction':
            const defaultDiscipline_29 = "Human-Machine Interaction and Fundamentals of Computer-Aided Design";
            const defaultCourse_29 = "4";
            const defaultCredits_29 = "3";
            nodeId = drawflowEditor.addNode(
                'people_machine_interaction',
                1,
                1,
                pos_x,
                pos_y,
                'people_machine_interaction',
                { "text": defaultDiscipline_29,
                  "course": defaultCourse_29,
                  "credits": defaultCredits_29
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_29}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_29}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_29}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'people_machine_interaction');
            break;
            case 'construction_of_software':
            const defaultDiscipline_30 = "Software design";
            const defaultCourse_30 = "4";
            const defaultCredits_30 = "3";
            nodeId = drawflowEditor.addNode(
                'construction_of_software',
                1,
                1,
                pos_x,
                pos_y,
                'construction_of_software',
                { "text": defaultDiscipline_30,
                  "course": defaultCourse_30,
                  "credits": defaultCredits_30
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_30}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_30}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_30}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'construction_of_software');
            break;
            case 'management_quality_of_software':
            const defaultDiscipline_31 = "Software Quality Management";
            const defaultCourse_31 = "4";
            const defaultCredits_31 = "4";
            nodeId = drawflowEditor.addNode(
                'management_quality_of_software',
                1,
                1,
                pos_x,
                pos_y,
                'management_quality_of_software',
                { "text": defaultDiscipline_31,
                  "course": defaultCourse_31,
                  "credits": defaultCredits_31
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_31}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_31}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_31}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'management_quality_of_software');
            break;
            case 'business_analytics':
            const defaultDiscipline_32 = "Business analytics and teamwork in IT";
            const defaultCourse_32 = "4";
            const defaultCredits_32 = "4,5";
            nodeId = drawflowEditor.addNode(
                'business_analytics',
                1,
                1,
                pos_x,
                pos_y,
                'business_analytics',
                { "text": defaultDiscipline_32,
                  "course": defaultCourse_32,
                  "credits": defaultCredits_32
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_32}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_32}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_32}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'business_analytics');
            break;
            case 'bachelor_work':
            const defaultDiscipline_33 = "Qualifying bachelor's thesis";
            const defaultCourse_33 = "4";
            const defaultCredits_33 = "9";
            nodeId = drawflowEditor.addNode(
                'bachelor_work',
                1,
                1,
                pos_x,
                pos_y,
                'bachelor_work',
                { "text": defaultDiscipline_33,
                  "course": defaultCourse_33,
                  "credits": defaultCredits_33
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_33}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_33}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_33}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'bachelor_work');
            break;
            case 'prod_pract':
            const defaultDiscipline_34 = "Production practice";
            const defaultCourse_34 = "4";
            const defaultCredits_34 = "6";
            nodeId = drawflowEditor.addNode(
                'prod_pract',
                1,
                1,
                pos_x,
                pos_y,
                'prod_pract',
                { "text": defaultDiscipline_34,
                  "course": defaultCourse_34,
                  "credits": defaultCredits_34
                },
                `<div>
                    <div class="title-box">
                        <textarea df-name placeholder="Enter the name of the discipline" readonly>${defaultDiscipline_34}</textarea>
                        <div class="df-field">
                        <label>Course:</label>
                        <input type="text" value="${defaultCourse_34}" readonly />
                        </div>
                        <div class="df-field">
                        <label>Credits:</label>
                        <input type="text" value="${defaultCredits_34}" readonly />
                        </div>
                    </div>
                </div>`
            );
            createdNodeTypes.set(Number(nodeId), 'prod_pract');

            // Delay for textarea to appear in DOM
            requestAnimationFrame(() => {
                const textarea = document.querySelector(`#node-${nodeId} textarea[df-name]`);
                if (textarea) {
                    textarea.style.overflow = 'hidden';
                    textarea.style.resize = 'none';
                    textarea.rows = 1;
                    textarea.style.cursor = 'default';

                    // We immediately set the height
                    autoResizeTextarea(textarea);

                    // Automatic resizing while typing
                    textarea.addEventListener('input', function () {
                        setTimeout(() => autoResizeTextarea(this), 0);
                    });
                }
            });
            break;

        default:
            console.warn("Unknown node type:", name);
            return false;
          }
        // Hide the node in the sidebar (except for blank)
        if (name !== 'blank') {
        const sidebarItem = document.querySelector(`.drag-drawflow[data-node="${name}"]`);
        if (sidebarItem) {
            sidebarItem.style.display = 'none';
        }
    }
    autoUpdateSchema();
}

function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

const debouncedAutoUpdateSchema = debounce(autoUpdateSchema, 500);

// Change textarea size after loading
function initializeAllTextareas() {
    const textareas = document.querySelectorAll("textarea[df-name]");
    textareas.forEach(textarea => {
        textarea.style.overflow = 'hidden';
        textarea.style.resize = 'none';
        textarea.rows = 1;

        requestAnimationFrame(() => {
            autoResizeTextarea(textarea);
        });

        textarea.addEventListener('input', function () {
            setTimeout(() => autoResizeTextarea(this), 0);
            debouncedAutoUpdateSchema();
        });
    });
}

function initializeAllInputs() {
    const inputs = document.querySelectorAll("input[df-course], input[df-credits]");
    inputs.forEach(input => {
        input.addEventListener('input', function () {
            debouncedAutoUpdateSchema();
        });
    });
}
    
var transform = '';
  function showpopup(e) {
    e.target.closest(".drawflow-node").style.zIndex = "9999";
    e.target.children[0].style.display = "block";
    //document.getElementById("modalfix").style.display = "block";

    //e.target.children[0].style.transform = 'translate('+translate.x+'px, '+translate.y+'px)';
    transform = drawflowEditor.precanvas.style.transform;
    drawflowEditor.precanvas.style.transform = '';
    drawflowEditor.precanvas.style.left = drawflowEditor.canvas_x +'px';
    drawflowEditor.precanvas.style.top = drawflowEditor.canvas_y +'px';
    console.log(transform);

    //e.target.children[0].style.top  =  -editor.canvas_y - editor.container.offsetTop +'px';
    //e.target.children[0].style.left  =  -editor.canvas_x  - editor.container.offsetLeft +'px';
    drawflowEditor.editor_mode = "fixed";

  }

   function closemodal(e) {
     e.target.closest(".drawflow-node").style.zIndex = "2";
     e.target.parentElement.parentElement.style.display  ="none";
     //document.getElementById("modalfix").style.display = "none";
     drawflowEditor.precanvas.style.transform = transform;
     drawflowEditor.precanvas.style.left = '0px';
     drawflowEditor.precanvas.style.top = '0px';
     drawflowEditor.editor_mode = "edit";
   }

    function changeMode(option) {

    //console.log(lock.id);
      if(option == 'lock') {
        lock.style.display = 'none';
        unlock.style.display = 'block';
      } else {
        lock.style.display = 'block';
        unlock.style.display = 'none';
      }
    }

    function exportJSONFromDatabase(schemaId) {
    fetch(`http://localhost:3000/get-schema/${schemaId}`)
        .then(response => response.json())
        .then(data => {
            if (!data || !data.schemaData) {
                throw new Error("Schematic not found!");
            }

            const exportData = data.schemaData;
            exportData.schemaTitle = data.title || "Untitled";

            const dataStr = JSON.stringify(exportData, null, 4);
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${exportData.schemaTitle}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        })
        .catch(error => {
            console.error("Export error:", error);
            alert("Failed to export schematic.");
        });
}

function importJSONFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const data = JSON.parse(e.target.result);

            if (!data.drawflow || !data.drawflow.Home || !data.drawflow.Home.data) {
                throw new Error("Invalid file format!");
            }

            // Displaying the schema in the editor
            drawflowEditor.clear();
            drawflowEditor.import(data);

            // Setting the schema title
            if (data.schemaTitle) {
                document.querySelector('.title-input').value = data.schemaTitle;
            }

            setTimeout(() => {
                initializeAllTextareas();
            }, 0);

            // Optional: automatic saving after import
            Swal.fire({
                title: 'Save imported schema?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
            }).then((result) => {
                if (result.isConfirmed) {
                    saveSchema();
                }
            });

        } catch (error) {
            console.error("Import JSON error:", error);
                Swal.fire({
                title: 'Import error',
                text: 'File could not be imported! Check the format.',
                icon: 'error',
                confirmButtonText: 'Ok',
                background: '#fff8f0',
                confirmButtonColor: '#d33',
                customClass: {
                    title: 'swal2-title-custom',
                    popup: 'swal2-popup-custom',
                    confirmButton: 'swal2-confirm-custom'
                }
            });
        }
    };
    reader.readAsText(file);
}
</script>
</body>
</html>